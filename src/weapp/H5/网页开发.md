微信支付文档：[https://pay.weixin.qq.com/wiki/doc/api/index.html](https://pay.weixin.qq.com/wiki/doc/api/index.html)

JDK链接: [https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html)


OpenID 是最对『微信应用』的用户唯一值，同一个『微信开发者账号』下的不同应用中，使用同一个『微信用户』登录，此值会不一样；UnionID 是针对『微信开发者账号』的用户唯一值，同一个『微信开发者账号』下的不同应用中，使用同一个『微信用户』登录，此值是一致的。

如果你在开发网站的微信登录，请数据库里记录 UnionID ，并使用 UnionID 来区分微信用户。如果你不这么做，假如后面网站新增了一个允许微信登录的 App 时，你将无法辨别用户。

## 1. 微信公众平台开发的简述

公众平台开发接口提供了基础服务，为了识别每个用户，每个用户针对每个公众号会产生一个安全的openID。如果需要在多个公众号，移动应用之间做用户共通，则需要前往微信开发平台，将这些公众号和应用绑定到一个开发平台账号下，一个用户虽然对多个公众号和应用有多个不同的openID,但他对所有这些同一开放平台账号下的公众号和应用，只有一个`UnionID`，在获取用户基本信息文档了解详情。

开发注意事项

- 公众平台以`access_token`为接口调用凭证，来调用接口，所有接口的调用需要先获取`access_token`, `access_token`在2个小时内有效，过期需要重新获取，但1天内获取次数有限，开发者需要存储。

- 公众平台接口调用仅支持80端口。

公众号主要通过公众号消息会话和公众号内的网页来为用户提供服务的

公众号内网页

1. 网页授权获取用户基本信息：通过该接口，可以获取用户的基本信息(获取用户的OpenID是无需用户同意的，获取用户的基本信息则需要用户同意)

2. 微信JS-JDK: 是开发者在网页上通过JavaScript代码使用微信原生功能的工具包，开发者可以使用它在网页上录制和播放微信语音，监听微信分享，上传手机本地图片，拍照等能力。

## 1. 微信的JS-JDK

微信的JS-JDK是微信提供开发者基于微信内的网页开发的工具包，如果开发者想使用一些微信的功能比如支付，拍照等必须先引入JDK才可以。

JDK链接: [https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html)

**JSSDK使用步骤**

1. 绑定域名

先登录微信公众平台进入“公众号设置”的“功能设置”里填写“JS接口安全域名”。

备注：登录后可在“开发者中心”查看对应的接口权限。

2. 引入JS文件

在需要调用JS接口的页面引入如下JS文件，（支持https）：http://res.wx.qq.com/open/js/jweixin-1.6.0.js

如需进一步提升服务稳定性，当上述资源不可访问时，可改访问：http://res2.wx.qq.com/open/js/jweixin-1.6.0.js （支持https）。

备注：支持使用 AMD/CMD 标准模块加载方法加载

3. 通过config接口注入权限验证配置

所有需要使用JS-SDK的页面必须先注入配置信息，否则将无法调用（同一个url仅需调用一次，对于变化url的SPA的web app可在每次url变化时进行调用,目前Android微信客户端不支持pushState的H5新特性，所以使用pushState来实现web app的页面会导致签名失败，此问题会在Android6.2中修复）。

```js
wx.config({
  debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
  appId: '', // 必填，公众号的唯一标识
  timestamp: , // 必填，生成签名的时间戳
  nonceStr: '', // 必填，生成签名的随机串
  signature: '',// 必填，签名
  jsApiList: [] // 必填，需要使用的JS接口列表
});
```

> 所有的要使用JSSDK的页面都要先注入配置(wx.config)，否则不能调用微信的东西。

4. 通过ready接口处理成功验证(判断wx.config是否成功)

```js
wx.ready(function(){
  // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口(指的是微信的接口)，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
});
```

5. 通过error接口处理失败验证

```js
wx.error(function(res){
  // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
});
```

**接口调用说明**

所有接口通过wx对象(也可使用jWeixin对象)来调用，参数是一个对象，除了每个接口本身需要传的参数之外，还有以下通用参数：

success：接口调用成功时执行的回调函数。

fail：接口调用失败时执行的回调函数。

complete：接口调用完成时执行的回调函数，无论成功或失败都会执行。

cancel：用户点击取消时的回调函数，仅部分有用户取消操作的api才会用到。

trigger: 监听Menu中的按钮点击时触发的方法，该方法仅支持Menu中的相关接口。

备注：不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回。

以上几个函数都带有一个参数，类型为对象，其中除了每个接口本身返回的数据之外，还有一个通用属性errMsg，其值格式如下：

调用成功时："xxx:ok" ，其中xxx为调用的接口名

用户取消时："xxx:cancel"，其中xxx为调用的接口名

调用失败时：其值为具体错误信息

> 以上是使用微信接口需要提前的准备，具体的接口比如拍照等如下 [https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html)



## 2. h5运行在微信内置浏览器上支付

微信内H5调起支付：[https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_7&index=6#](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_7&index=6#)


在微信浏览器中打开h5网页执行JS调起支付，接口的输入输出都是JSON形式。

> 内置对象WeixinJSBridge在其他浏览器中无效

支付时需传入的参数`getBrandWCPayRequest`的介绍以及返回值定义

- 请求接口参数列表(在进行支付时需要重新进行签名计算，所以在调微信支付时需要提前调取一个签名参数的接口)

名称|变量名|必填|类型|示例值|描述
--| :--|:--|:--|:--|:
公众号id|appid|是|String(16)|wx8888888888888888|商户注册具有支付权限的公众号成功后即可获得
时间戳|timeStamp|是|String(32)|1414561699|当前的时间(以北京时间为准，如果不是需要转化)
随机字符串|nonceStr|是|String(32)|5K8264ILTKCH16CQ2502SI8ZNMTM67VS|随机字符串，不长于32位
订单详情扩展字符串|package|是|String(128)|prepay_id=123456789|统一下单接口返回的prepay_id参数值，提交格式如：prepay_id=***
签名方式|signType|是|String(32)|MD5|签名类型，默认为MD5，支持HMAC-SHA256和MD5。注意此处需与统一下单的签名类型一致
签名|paySign|是|String(64)|C380BEC2BFD727A4B6845133519F3AD6|签名，详见[详情](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=4_3)

- 返回结果说明

返回值|描述
--|:--
get_brand_wcpay_request:ok|支付成功
get_brand_wcpay_request:cancel|支付过程中用户取消
get_brand_wcpay_request:fail|支付失败
调用支付JSAPI缺少参数：total_fee|1、请检查预支付会话标识prepay_id是否已失效2、请求的appid与下单接口的appid是否一致

支付流程

一般提交订单后，有了订单就会唤起支付(有了订单在唤起支付前需要先请求需要签名的参数)

```js
// 提交订单，请求回来签名需要的参数后调这个函数
function pay() {
    if (typeof WeixinJSBridge == "undefined") {
      if (document.addEventListener) {
          document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
      } else if (document.attachEvent) {
          document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
          document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
      }
    } else {
      //将唤醒微信支付页面前的数据进行处理
      onBridgeReady();
    }
}
```

```js
function onBridgeReady(){
  const params = {
    "appId":"wx2421b1c4370ec43b",     //公众号名称，由商户传入     
    "timeStamp":"1395712654",         //时间戳，自1970年以来的秒数     
    "nonceStr":"e61463f8efa94090b1f366cccfbbb444", //随机串     
    "package":"prepay_id=u802345jgfjsdfgsdg888",     
    "signType":"MD5",         //微信签名方式：     
    "paySign":"70EA570631E4BB79628FBCA90534C63FF7FADD89" //微信签名 
  },
  WeixinJSBridge.invoke(
    'getBrandWCPayRequest', params, 
    function(res){
    if(res.err_msg == "get_brand_wcpay_request:ok" ){
    } 
  }); 
}
```