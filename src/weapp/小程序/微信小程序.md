## 微信小程序

#### 1. 有效期本地缓存

首先我们应该知道在微信中是没有cookie的，只有storage，如果想使本地缓存具有有效期，那必须我们自己去触发，不会自动删除。

> 思路：当缓存某个要缓存的值时，可以跟着一起存一个这个值失效的时间点。当我们去获取这个值时，然后拿到当前的时间，跟缓存时的时间作对比，如果现在的时间大于设置的时间点，就说明缓存的这个值已经失效，直接删除，返回一个标识。如果小于则说明缓存的值有效，可以使用，返回一个标识。

```js
wx.setStorageSync(key, value); // 存值
wx.getStorageSync(key); // 取值
wx.removeStorageSync(key); // 删除
```

需求：如果某个用户进入页面要填写信息，第一次填写后，当天就不用填写，直接可进入。

```js
// 进入页面时 使用这个用户的身份证作标识
if (wx.getStorageSync('cacheTime')) {
    let cacheTimeVal = wx.getStorageSync('cacheTime')
    cacheTimeVal.idCord.push(userMsg.visitIdNumber)
    setCacheTime('cacheTime', cacheTimeVal)
} else {
    let depositIDCard = {}
    depositIDCard.time = new Date(new Date().toLocaleDateString()).getTime() + 24 * 60 * 60 * 1000
    let idCord = []
    idCord.push(userMsg.visitIdNumber)
    depositIDCard.idCord = idCord
    setCacheTime('cacheTime', depositIDCard)
}
```



```js
/**
 * 设置时效缓存
 * @param  {String} key    存储的key值
 * @param  {String} value  存储的value值
 */

const setCacheTime = (key, value) => {
  wx.setStorageSync(key, value)
}

/**
 * 读取时效缓存
 * @param   {String}  key  存储的key值
 * 人脸识别：true，不识别为false
 */

const getCacheTime = (key, idCardNumber) => {
  const failureVal = wx.getStorageSync(key)
  // 1. 判断缓存存在否， 2. 判断时间是否失效， 3. 判断身份证是否存在【缓存时间不存在时也要填写信息】
  if (failureVal) { // 缓存存在不
    if (failureVal.time < (new Date().getTime())) { //  时间失效没
      wx.removeStorageSync(key)
      console.log('超过失效时间了')
      return true
    } else {
      // 判断身份证
      // const failureCarrd = failureVal.idCord
      const idCordBoolean = failureVal.idCord.some(item => item === idCardNumber)
      return !idCordBoolean
    }
  } else { // 缓存不存在
    console.log('缓存不存在')
    return true
  }
}
```
#### 2. 小程序中的尺寸单位rpx

rpx是微信小程序中的css的尺寸单位，rpx可以根据屏幕宽度进行自适应。规定屏幕宽为750rpx，如果在iphone6上，屏幕宽度为375px，共有750个
物理像素，则750rpx = 375px = 750物理像素， 1rpx = 0.5px = 1物理像素

rpx转px: 屏幕宽度 / 750

px转rpx: 750 / 屏幕宽度

当设计稿为750px时1rpx = 1px

#### 3. 路由

**wx.navigateTo(Object object)**

保留当前页面，跳转到应用内的某个页面。但不能跳转到`tabbar`页面，使用`wx.navigateBack`可以返回原页面，小程序中页面栈最多十层。

参数

属性|类型|默认值|必填项|说明
--|:--:|--:|--:|--:
url|string||是|需要跳转的应用内非 tabBar 的页面的路径 (代码包路径), 路径后可以带参数。参数与路径之间使用 ? 分隔，参数键与参数值用 = 相连，不同参数用 & 分隔；如 'path?key=value&key2=value2'
success|function||否|接口调用成功的回调函数
fail|function||否|接口调用失败的回调函数
complete|function||否|接口调用结束的回调函数（调用成功、失败都会执行）

例子：

会向栈中添加，会出现重复。



**wx.navigateBack(Object object)**

关闭当前页面，返回上一页面或多级页面，可通过`getCurrentPages`获取当前的页面栈，决定需要返回几层

参数

属性|类型|默认值|必填项|说明
--|:--:|--:|--:|--:
delta|number|1|否|返回的页面数，如果 delta 大于现有页面数，则返回到首页
success|function||否|接口调用成功的回调函数
fail|function||否|接口调用失败的回调函数
complete|function||否|接口调用结束的回调函数（调用成功、失败都会执行）

**wx.switchTab(Object object)**

跳转到tabBar页面，并关闭当前其他非tabBar页面

参数

属性|类型|默认值|必填项|说明
--|:--:|--:|--:|--:
url|string||是|需要跳转的 tabBar 页面的路径 (代码包路径)（需在 app.json 的 tabBar 字段定义的页面），路径后不能带参数
success|function||否|接口调用成功的回调函数
fail|function||否|接口调用失败的回调函数
complete|function||否|接口调用结束的回调函数（调用成功、失败都会执行）


```js
wx.switchTab({
  url: '/index'
})
```
**wx.redirectTo(Object object)**

关闭当前页面，跳转到应用内的某个页面，不能跳转到tabbar页面

参数

属性|类型|默认值|必填项|说明
--|:--:|--:|--:|--:
url|string||是|需要跳转的应用内非 tabBar 的页面的路径 (代码包路径), 路径后可以带参数。参数与路径之间使用 ? 分隔，参数键与参数值用 = 相连，不同参数用 & 分隔；如 'path?key=value&key2=value2'
success|function||否|接口调用成功的回调函数
fail|function||否|接口调用失败的回调函数
complete|function||否|接口调用结束的回调函数（调用成功、失败都会执行）

例子：

A -》 B，B - 》使用redirectTo会使栈中有两个A，在A页面点击返回又会回到A页面。



**wx.reLaunch(Object object)**

关闭所有页面，打开应用内的某个页面

参数

属性|类型|默认值|必填项|说明
--|:--:|--:|--:|--:
url|string||是|需要跳转的应用内页面路径 (代码包路径)，路径后可以带参数。参数与路径之间使用?分隔，参数键与参数值用=相连，不同参数用&分隔；如 'path?key=value&key2=value2'
success|function||否|接口调用成功的回调函数
fail|function||否|接口调用失败的回调函数
complete|function||否|接口调用结束的回调函数（调用成功、失败都会执行）

注: 微信跳转时需要使用绝对路径




#### 4. 小程序中的事件

1. 什么是事件

- 事件是视觉层到逻辑层的通讯方式
- 事件可以将用户的行为反馈到逻辑层进行处理
- 事件可以绑定在组件上，当达到触发事件，就会执行逻辑层中对应的事件处理函数
- 事件对象可以携带额外参数，如id

2. 事件的分类，可分为冒泡事件和非冒泡事件

冒泡事件在事件类型前加`bind`, 比如点击事件`tap`, 书写时为`bindtap`

非冒泡事件在事件类型前加`catch`, 如果点击事件`tap`, 书写时为`catchtap`。`catch`会阻止冒泡事件，而`bind`不会阻止

事件类型（冒泡）

类型|触发条件|最低版本
--|:--:|--:
touchstart|手指触摸动作开始|
touchmove|手指触摸后移动|
touchcancel|手指触摸动作被打断，如来电提醒，弹窗|
touchend|手指触摸动作结束|
tap|手指触摸后马上离开(点击)|
longpress|手指触摸后，超过350ms再离开，如果指定了事件回调函数并触发了这个事件，tap事件将不被触发|1.5.0
longtap|手指触摸后，超过350ms再离开（推荐使用longpress事件代替）|
transitionend|会在 WXSS transition 或 wx.createAnimation 动画结束后触发|
animationstart|会在一个 WXSS animation 动画开始时触发|
animationiteration|会在一个 WXSS animation 一次迭代结束时触发|
animationend|会在一个 WXSS animation 动画完成时触发|
touchforcechange|在支持 3D Touch 的 iPhone 设备，重按时会触发|	1.9.90

非冒泡事件类型

form的`form`事件，input的`input`事件，scroll-view的`scroll`事件等

3. 
mpvue框架中的事件与原生小程序事件的转化

```js
// 事件映射表，左侧为 WEB 事件，右侧为 小程序 对应事件
{
    click: 'tap',
    touchstart: 'touchstart',
    touchmove: 'touchmove',
    touchcancel: 'touchcancel',
    touchend: 'touchend',
    tap: 'tap',
    longtap: 'longtap',
    input: 'input',
    change: 'change',
    submit: 'submit',
    blur: 'blur',
    focus: 'focus',
    reset: 'reset',
    confirm: 'confirm',
    columnchange: 'columnchange',
    linechange: 'linechange',
    error: 'error',
    scrolltoupper: 'scrolltoupper',
    scrolltolower: 'scrolltolower',
    scroll: 'scroll'
}
// 在input和textarea中change事件会被转化为blur事件
```

4. 关于事件注意问题

例子1.

tap,touchstart,touchend的事件触发顺序为start→end→tap

有滑动和点击事件，这样写点击事件(toggleLeft1)会失效, 原因则是因为滑动用的是`catch`会阻止冒泡,捕获不到`tap`, 改为`bind`即可。
```js
<view catchtouchstart='buttonStart' catchtouchmove='buttonMove' class='menu_block' bindtap='toggleLeft1' style='top:{{buttonTop}}px;left:{{buttonLeft}}px;'>
  <i-icon type="other" size="28" color="#80848f" />
</view>
```

#### 5. 生命周期

从三方面介绍小程序的生命周期

(1) 应用生命周期
(2) 页面生命周期
(3) 应用及页面生命周期的触发顺序

1. 应用生命周期

App()函数用来注册一个小程序,必须在app.js中调用，必须调用且只能调用一次。

(1) onLaunch: 初始化小程序触发，全局只触发一次。

(2) onShow: 小程序初始化完成或用户从后台切换到前台时触发。

(3) onHide: 用户从前台切换到后台隐藏时触发

(4) onError: 小程序发生脚本错误，获取api调用失败时，会触发onError并带上错误信息

后台：点击左上角关闭，或者按了home键，离开了微信，此时并没有销毁，而是进入到了后台

前台：再次进入小程序或者微信，相当于从后台进入前台

```js
App({
  onLunch: function() {
    // 小程序初始化
  },
  onShow: function() {
    // 小程序显示，从后台进入前台
  },
  hide: function() {
    // 小程序隐藏，从前台进入后台
  },
  onError: function() {
    // 监听错误
  }
})
```

注意：不要在 onLaunch 的时候调用 getCurrentPage()，此时 page 还没有生成。

2. 页面生命周期

Page()函数用来注册一个页面，接受一个object函数，其指定页面的初始数据，生命周期函数和事件处理函数等

data：页面的初始数据

onLoad: 首次进入页面加载时触发，可以在onLoad的参数中获取当前路径中的参数

onShow: 加载完成后，后台切换到前台或重新进入页面触发

onReady: 页面首次渲染完成时触发

onHide: 从前台切换到后台或进入其他页面触发

onUnload: 页面卸载时触发

```js
Page({
  // 页面加载 一个页面只调用一次
  onLoad: function(options) {
    // options url传过来的参数
  },
  // 页面加载初次完成
  onReady: function() {
  },
  // 页面显示
  onShow: function() {
  },
  // 页面隐藏
  onHide: function() {
  },
  // 页面卸载
  onUnload: function() {
  },
  // 其他的页面函数
  onPullDownRefresh: function() {
    // 监听用户下拉动作
  },
  onReachBottom: function() {
    // 页面上拉触底事件的处理函数
  },
  onShareAppMessage: function() {
    // 用户点击右上角转发
  },
  onShareTimeline: function() {
    // 用户点击右上角转发到朋友圈
  },
  onAddToFavorites: function() {
    // 用户点击右上角收藏
  },
  onPageScroll: function() {
    // 页面滚动触发事件的处理函数
  },
  onResize: function() {
    // 页面尺寸改变时触发
  },
  onTabltemTap: function() {
    // 当前是tab页时，点击tab时触发
  }
})
```

#### 6. 上传文件

小程序的上传分为两步，第一步是找到打开本设备(手机)的文件，第二步选择要上传的文件，要分别调用微信函数获取。

- 选择文件为图片

wx.chooselmage(Object, object) 从本地相册选择图片或使用相机拍照

属性| 类型| 默认值 | 必填 | 说明
--| :--:|--:|--:|--:
count|number|9|否|最多可以选择的图片张数
sizeType|Array[String]|['original', 'compressed']|否|所选图片的尺寸： original原图 compressed压缩图
sourceType|Array[String]|['album', 'camera']|否|选择图片的来源: album从相册 camera使用相机
success|Function||是|接口调用成功的回调函数
fail|Function||否|接口调用失败的回调函数
complete|Function||否|接口调用接收后的回调函数，不管成功还是失败都会执行

成功后的回调函数返回的值

属性| 类型| 说明
--|   :|    --:
tempFilePaths| Array[String] | 图片的本地临时路径列表
tempFiles| Array[Object]|图片的本地临时列表

- 文件上传

wx.uploadFile(Object, object)将本地资源上传到服务器。客户端发起一个HTTP POST 请求，其中`content-type`为`multipart/form-data`

属性| 类型| 默认值 | 必填 | 说明
--| :--:|--:|--:|--:
url|string||是|请求地址
filePath|string||是|要上传文件资源的路径(本地路径)
name|string||是|文件对应的key(就是后端定义的字段名称)
header|Object||否|HTTP请求Header, Header中不能设置Referer
formData|Object||否|HTTP请求其他的额外参数
timeout|number||否|超时时间，单位毫秒
success|Function||否|接口调用成功后的回调函数
fail|Function||否|接口调用失败后的回调函数
complete|Function||否|接口调用结束后的回调函数(成功失败都调用)

成功后返回的值

属性| 类型| 说明
--| :--:|--:
data|string|后台返回的数据
statusCode|number|后台返回的状态码

#### 7. 位置

- wx.getLocation(Object, object);

> 调用前需要用户授权

> 获取当前的地理位置、速度。当用户离开小程序后，此接口无法调用。开启高精度定位，接口耗时会增加，可指定 highAccuracyExpireTime 作为超时时间。地图相关使用的坐标格式应为 gcj02。

详情链接: [详情链接](https://developers.weixin.qq.com/miniprogram/dev/api/location/wx.getLocation.html)


